{% extends "base.html" %}

{% block content %}
<div class="container my-5">
  <div class="card shadow-sm mx-auto" style="max-width: 500px;">
    <div class="card-body">
      <h3 class="card-title text-center mb-4">Partner Password Reset</h3>

      <!-- STEP 1: Enter Email / Phone -->
      <div id="step-1">
        <p>Enter your registered Email to reset your password:</p>
        <input type="text" id="identifier" class="form-control mb-2" placeholder="Email or Phone">
        <button id="send-otp" class="btn btn-primary w-100">Send OTP</button>
        <div id="step-1-error" class="text-danger mt-2"></div>
      </div>

      <!-- STEP 2: Enter OTP -->
      <div id="step-2" style="display:none;">
        <!-- FIX: This message now confirms that the OTP was sent -->
        <p class="text-success">An OTP has been sent to your registered email. Please enter it below:</p>
        <input type="text" id="otp" class="form-control mb-2" placeholder="OTP">
        <button id="verify-otp" class="btn btn-primary w-100">Verify OTP</button>
        <div id="step-2-error" class="text-danger mt-2"></div>
      </div>

      <!-- STEP 3: Reset Password -->
      <div id="step-3" style="display:none;">
        <p>Enter your new password:</p>
        <input type="password" id="password" class="form-control mb-2" placeholder="New Password">
        <input type="password" id="confirm-password" class="form-control mb-2" placeholder="Confirm Password">
        <button id="reset-password" class="btn btn-success w-100">Reset Password</button>
        <div id="step-3-error" class="text-danger mt-2"></div>
      </div>

      <div id="success-msg" style="display:none;" class="alert alert-success mt-3 text-center">
        <!-- This will be filled by JS -->
      </div>

    </div>
  </div>
</div>

<script>
const csrftoken = '{{ csrf_token }}';

function postData(url, data) {
    return fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(data)
    }).then(res => res.json());
}

let currentIdentifier = "";

// --- URLs are updated to point to the 'partner' app ---

// Step 1: Send OTP
document.getElementById('send-otp').addEventListener('click', () => {
    currentIdentifier = document.getElementById('identifier').value.trim();
    // Optional: Add a loading state to the button
    const sendOtpBtn = document.getElementById('send-otp');
    sendOtpBtn.disabled = true;
    sendOtpBtn.innerText = 'Sending...';

    postData("{% url 'partner:ajax_send_otp' %}", { identifier: currentIdentifier })
    .then(res => {
        if (res.success) {
            document.getElementById('step-1-error').innerText = "";
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'block';
        } else {
            document.getElementById('step-1-error').innerText = res.message;
        }
    }).finally(() => {
        // Reset button state
        sendOtpBtn.disabled = false;
        sendOtpBtn.innerText = 'Send OTP';
    });
});

// Step 2: Verify OTP
document.getElementById('verify-otp').addEventListener('click', () => {
    const otp = document.getElementById('otp').value.trim();
    postData("{% url 'partner:ajax_verify_otp' %}", { identifier: currentIdentifier, otp })
    .then(res => {
        if (res.success) {
            document.getElementById('step-2-error').innerText = "";
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('step-3').style.display = 'block';
        } else {
            document.getElementById('step-2-error').innerText = res.message;
        }
    });
});

// Step 3: Reset Password
document.getElementById('reset-password').addEventListener('click', () => {
    const password = document.getElementById('password').value.trim();
    const confirmPassword = document.getElementById('confirm-password').value.trim();

    if (password !== confirmPassword) {
        document.getElementById('step-3-error').innerText = "Passwords do not match.";
        return;
    }

    postData("{% url 'partner:ajax_reset_password' %}", { identifier: currentIdentifier, new_password: password })
    .then(res => {
        if (res.success) {
            document.getElementById('step-3-error').innerText = "";
            document.getElementById('step-3').style.display = 'none';
            const successDiv = document.getElementById('success-msg');
            // FIX: Create a dynamic success message with a login link
            successDiv.innerHTML = `${res.message} You can now <a href="{% url 'partner:login' %}">login</a>.`;
            successDiv.style.display = 'block';
        } else {
            document.getElementById('step-3-error').innerText = res.message;
        }
    });
});
</script>

{% endblock %}
